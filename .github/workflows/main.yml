name: DeepSeek Auto Code Review (Korean)

on:
  push:
    branches:
      - develop
      - main
      - master

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate git diff
        run: |
          echo "Generating diff..."
          git fetch --unshallow || true
          git diff HEAD~1 HEAD > changes.patch
          echo "--- Generated diff ---"
          cat changes.patch || echo "No diff found"

      - name: Run DeepSeek Code Review
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "Preparing diff..."
          # 제어문자 제거
          DIFF=$(cat changes.patch | tr -d '\000-\037')
          # 큰따옴표 이스케이프
          DIFF_ESCAPED=${DIFF//\"/\\\"}
          
          echo "Sending diff to DeepSeek API..."
          RESPONSE=$(curl -s https://api.deepseek.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
            -d "{
              \"model\": \"deepseek-chat\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"당신은 숙련된 소프트웨어 엔지니어입니다. 아래 코드 diff를 보고, 문제점, 개선점, 버그 가능성 등을 상세히 한국어로 리뷰해 주세요.\"},
                {\"role\": \"user\", \"content\": \"$DIFF_ESCAPED\"}
              ]
            }")
          
          echo "DeepSeek 리뷰 결과:"
          echo "$RESPONSE" > deepseek_review.json
          cat deepseek_review.json
