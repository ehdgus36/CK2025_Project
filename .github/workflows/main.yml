name: Gemini Auto Code Review (Korean)

on:
  push:
    branches:
      - develop
      - main
      - master

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate diff
        run: |
          echo "Generating diff..."
          git fetch --unshallow || true
          git diff HEAD~1 HEAD > changes.patch
          echo "--- Generated diff ---"
          cat changes.patch || echo "No diff found"

      - name: Run Gemini Code Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "Sending diff to Gemini API..."
          RESPONSE=$(curl -s https://gemini.googleapis.com/v1/assistants:complete \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GEMINI_API_KEY" \
            -d "{
              \"model\": \"gemini-code-latest\",
              \"instructions\": \"당신은 숙련된 소프트웨어 엔지니어입니다. 아래 코드 diff를 보고, 문제점, 개선 방법, 버그 가능성, 최적의 작성 방법 등을 **한국어로** 상세히 리뷰해 주세요.\",
              \"input\": \"$(sed 's/"/\\"/g' changes.patch)\"
            }")
          echo "Gemini 리뷰 결과:"
          echo "$RESPONSE" > gemini_review_ko.json
          cat gemini_review_ko.json
